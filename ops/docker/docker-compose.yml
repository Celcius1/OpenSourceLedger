services:
  # 1. THE VAULT (PostgreSQL Database)
  osl-vault:
    image: postgres:15-alpine
    container_name: osl-vault # Standardised
    restart: always
    environment:
      POSTGRES_USER: osl_admin
      POSTGRES_PASSWORD: Pr@toss2026!
      POSTGRES_DB: osl_main
    volumes:
      - osl_ledger_data:/var/lib/postgresql/data
      - ../sql/init_schema.sql:/docker-entrypoint-initdb.d/init.sql:ro # Fixed path
    networks:
      - osl_internal_net

  # 2. THE AUTHENTICATOR (Authelia)
  osl-auth:
    image: authelia/authelia
    container_name: osl-auth # Standardised
    volumes:
      - ./auth/config:/config
    networks:
      - osl_internal_net
    ports:
      - "0.0.0.0:9094:9091" # Avoids conflict with Gluetun port 9091
    restart: unless-stopped
    environment:
      - TZ=Australia/Adelaide

  # 3. THE BRAIN (C++ Core Engine)
  osl-core:
    build:
      context: ../../
      dockerfile: ops/docker/Dockerfile.core
    container_name: osl-core # Standardised
    restart: always
    volumes:
      - ../../src/web:/web
    ports:
      - "127.0.0.1:9000:8080"
    environment:
      - OSL_PORT=8080
      - OSL_AUTH_MODE=HYBRID 
      - OSL_BACKUP_USER=admin
      - OSL_BACKUP_PASS=Sovereign2026!
      - OSL_BASE_DOMAIN=osl.net.au
      - OSL_SESSION_SECRET=3673bead835d6164cdcff9941925f3c3ca674314d711d5453b02d7b3be655002
      - OSL_DB_CONN=host=osl-vault user=osl_admin password=Pr@toss2026! dbname=osl_main
    networks:
      - osl_internal_net
      - default
    depends_on:
      - osl-vault

networks:
  osl_internal_net: # Standardised name
    name: osl_internal_net
    #internal: true

volumes:
  osl_ledger_data:
