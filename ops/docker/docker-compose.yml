services:
  # 1. THE VAULT (PostgreSQL Database)
  osl-vault:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: osl_admin
      POSTGRES_PASSWORD: change_me_in_production_please
      POSTGRES_DB: osl_main
    volumes:
      - osl_ledger_data:/var/lib/postgresql/data
      - ../../schema/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - internal_trust_net

  # 2. THE AUTENTICATOR (Authelia)

  osl-auth:
    image: authelia/authelia
    container_name: osl-auth
    volumes:
      - ./auth/config:/config
    networks:
      - internal_trust_net
    ports:
      - "9093:9091" # Native Authelia port 9091 mapped to 9093 on host
    restart: unless-stopped
    environment:
      - TZ=Australia/Adelaide

  # 3. THE BRAIN (C++ Core Engine)
  osl-core:
    build:
      context: ../../
      dockerfile: ops/docker/Dockerfile.core
    restart: always
    ports:
      - "127.0.0.1:9000:8080" # Map 9000 (Caddy) to 8080 (App)
    environment:
      - OSL_PORT=8080
      - OSL_AUTH_MODE=HYBRID 
      - OSL_BACKUP_USER=admin
      - OSL_BACKUP_PASS=Sovereign2026!
    networks:
      - internal_trust_net
      - default
    depends_on:
      - osl-vault

networks:
  internal_trust_net:
    internal: true  # This prevents the database from seeing the outside world

volumes:
  osl_ledger_data:
