services:
  # 1. THE VAULT (PostgreSQL Database)
  # Completely isolated. Only accessible by the Core.
  osl-vault:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: osl_admin
      POSTGRES_PASSWORD: change_me_in_production_please
      POSTGRES_DB: osl_main
    volumes:
      - osl_ledger_data:/var/lib/postgresql/data
      - ../../schema/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - internal_trust_net

  # 2. THE INTERNAL ROUTER (Nginx)
  # Serves the Frontend assets and proxies API calls to the C++ Core.
  # This container exposes ONE port (9000) to your Host Caddy.
  osl-web:
    image: nginx:alpine
    restart: always
    ports:
      # Bind ONLY to localhost so no outside traffic can bypass your main Caddy
      - "127.0.0.1:9000:80"
    volumes:
      # We will create a simple nginx config next
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      # The Frontend Build (React/Vue/HTML)
      - ../../src/frontend/dist:/usr/share/nginx/html:ro
    networks:
      - internal_trust_net
    depends_on:
      - osl-core

  # 3. THE BRAIN (C++ Core Engine)
  # Placeholder for now.
  osl-core:
    image: alpine:latest
    command: tail -f /dev/null
    networks:
      - internal_trust_net

networks:
  internal_trust_net:
    internal: true

volumes:
  osl_ledger_data:
